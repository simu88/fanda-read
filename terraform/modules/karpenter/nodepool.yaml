apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: fanda-karpenter-nodepool
spec:
  template:
    metadata:
      labels:
        # [권장] 이 키를 모든 애플리케이션의 affinity에서 사용해야 합니다.
        fanda-compute-type: application 

    spec:
      requirements:
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
        - key: kubernetes.io/arch
          operator: In
          #values: ["arm64","amd64"]  #혼합
          values: ["amd64"]

      
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: fanda-karpenter-ec2class
  # [수정 1] 노드 만료 설정이 "disruption" 블록 밖으로 이동하고 이름이 변경됨

  disruption:
    consolidationPolicy:  WhenEmptyOrUnderutilized
    consolidateAfter: "30m" # 값을 따옴표로 감싸는 것이 더 안전합니다.
    
---
apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: fanda-karpenter-ec2class
spec:
  # [수정 2] amiFamily가 amiSelectorTerms 안으로 이동함
  amiSelectorTerms:
    - alias: "al2@latest" # Amazon Linux 2 최신 버전을 의미하는 별칭
  # [중요] 이 역할 이름은 Terraform으로 생성한 실제 역할 이름과 일치해야 합니다.
  role: "fanda-karpenter-node-role"
  # [수정 3] subnetSelector 및 securityGroupSelector의 이름과 구조 변경
  subnetSelectorTerms:
    - tags:
        "karpenter.sh/discovery": "fanda-eks"
  securityGroupSelectorTerms:
    - tags:
        "karpenter.sh/discovery": "fanda-eks"
